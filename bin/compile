#!/bin/sh
# bin/compile <build-dir> <cache-dir> <env-dir>

DOWNLOAD_URL="https://download.newrelic.com/infrastructure_agent/binaries/linux/amd64/newrelic-infra_linux_1.59.0_amd64.tar.gz"
filename="newrelic-infra-binary.tar.gz"
BUILD_DIR="./"

curl --silent --retry 3 -o "$filename" -LN -D - "$DOWNLOAD_URL"

tar -zxvf $filename -C $BUILD_DIR

chmod +x newrelic-infra

cd "newrelic-infra" || exit

# Access the license key from the Heroku config var
# NEW_RELIC_LICENSE_KEY="${NEW_RELIC_LICENSE_KEY:-}"
NEW_RELIC_LICENSE_KEY=$(heroku-config:get NEW_RELIC_LICENSE_KEY)
NEW_RELIC_APP_NAME=$(heroku-config:get NEW_RELIC_APP_NAME)
echo "New Relic License Key: \"$NEW_RELIC_LICENSE_KEY\""
echo "$NEW_RELIC_APP_NAME"

# Check if the license key is set
# if [ -z "$NEW_RELIC_LICENSE_KEY" ]; then
#   echo "Error: NEW_RELIC_LICENSE_KEY config var is not set."
#   exit 1
# fi

if [ -z "$NEW_RELIC_APP_NAME" ]; then
  echo "Error: NEW_RELIC_LICENSE_KEY config var is not set."
  exit 1
fi