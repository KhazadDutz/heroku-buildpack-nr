#!/bin/sh
# bin/compile <build-dir> <cache-dir> <env-dir>

# Parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# identify OS
os="unknown"
uname_os=$(uname -s)
if [ "$uname_os" = "Darwin" ]; then
  os="macos"
elif [ "$uname_os" = "Linux" ]; then
  os="linux"
elif [ "$uname_os" = "FreeBSD" ]; then
  os="freebsd"
elif [ "$uname_os" = "OpenBSD" ]; then
  os="openbsd"
elif [ "$uname_os" = "NetBSD" ]; then
  os="netbsd"
else
  echo "ERROR: Unsupported OS '$uname_os'"
  echo ""
  clean_exit 1
fi

echo "Detected OS '$os'"

# identify arch
arch="unknown"
uname_machine=$(uname -m)
if [ "$uname_machine" = "i386" ] || [ "$uname_machine" = "i686" ]; then
  arch="i386"
elif [ "$uname_machine" = "amd64" ] || [ "$uname_machine" = "x86_64" ]; then
  arch="amd64"
elif [ "$uname_machine" = "armv6" ] || [ "$uname_machine" = "armv6l" ]; then
  arch="armv6"
elif [ "$uname_machine" = "armv7" ] || [ "$uname_machine" = "armv7l" ]; then
  arch="armv7"
# armv8?
elif [ "$uname_machine" = "arm64" ]; then
  arch="arm64"
else
  echo "ERROR: Unsupported architecture '$uname_machine'"
  echo ""
  clean_exit 1
fi

echo "Detected architecture '$arch'"

echo "Install New Relic CLI"
# Install the New Relic CLI
curl -Ls https://download.newrelic.com/install/newrelic-cli/scripts/install.sh | bash

echo "Check NEW RELIC ENV"
# Set New Relic environment variables from Heroku Config Vars
NEW_RELIC_API_KEY="${NEW_RELIC_API_KEY:-}"
NEW_RELIC_ACCOUNT_ID="${NEW_RELIC_ACCOUNT_ID:-}"

# Check if required config vars are set
if [ -z "$NEW_RELIC_API_KEY" ]; then
  echo "Error: NEW_RELIC_API_KEY config var is not set."
  exit 1 # Exit with an error code
fi

if [ -z "$NEW_RELIC_ACCOUNT_ID" ]; then
  echo "Error: NEW_RELIC_ACCOUNT_ID config var is not set."
  exit 1 # Exit with an error code
fi

echo "Instal New Relic Apache Integration"
# Install the New Relic Apache integration
/usr/local/bin/newrelic install -n apache-open-source-integration

# Check the exit status of the New Relic install command
if [ $? -ne 0 ]; then
    echo "Error: New Relic installation failed."
    exit 1
fi

# filename="doppler-download.tar.gz"

# curl --silent --retry 3 -o "$filename" -LN -D - "$DOWNLOAD_URL"

# tar -zxvf $filename -C $BUILD_DIR

# chmod +x $BUILD_DIR/doppler

# cd "$BUILD_DIR" || exit

# DOPPLER_TOKEN=$(cat $ENV_DIR/DOPPLER_TOKEN)

# ./doppler secrets download --token $DOPPLER_TOKEN --no-file --format env > .env

# curl -Ls https://download.newrelic.com/install/newrelic-cli/scripts/install.sh | bash && sudo NEW_RELIC_API_KEY=INSERT_YOUR_API_KEY NEW_RELIC_ACCOUNT_ID=INSERT_YOUR_ACCOUNT_ID /usr/local/bin/newrelic install -n apache-open-source-integration