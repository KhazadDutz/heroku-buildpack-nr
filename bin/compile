#!/bin/sh
# bin/compile <build-dir> <cache-dir> <env-dir>

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

DOWNLOAD_URL="https://download.newrelic.com/infrastructure_agent/binaries/linux/amd64/newrelic-infra_linux_1.59.0_amd64.tar.gz"
filename="newrelic-infra-binary.tar.gz"
BUILD_DIR="./"

curl --silent --retry 3 -o "$filename" -LN -D - "$DOWNLOAD_URL"

tar -zxvf $filename -C $BUILD_DIR

chmod +x newrelic-infra

# Access the license key from the Heroku config var
NEW_RELIC_LICENSE_KEY=$(cat $ENV_DIR/NEW_RELIC_LICENSE_KEY)
# echo "New Relic License Key: \"$NEW_RELIC_LICENSE_KEY\""

cd "newrelic-infra" || exit

# Check if the license key is set
if [ -z "$NEW_RELIC_LICENSE_KEY" ]; then
  echo "Error: NEW_RELIC_LICENSE_KEY config var is not set."
  exit 1
fi
